name: Code Quality

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'

jobs:
  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort mypy bandit safety
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run comprehensive code analysis
        run: |
          echo "ğŸ” Running code quality analysis..."
          
          # Create reports directory
          mkdir -p reports
          
          # Flake8 for style and complexity
          echo "ğŸ“ Running flake8..."
          flake8 src tests --format=json --output-file=reports/flake8-report.json --exit-zero
          
          # Black for formatting check
          echo "ğŸ¨ Checking code formatting..."
          black --check --diff src tests > reports/black-report.txt 2>&1 || true
          
          # isort for import sorting
          echo "ğŸ“¦ Checking import sorting..."
          isort --check-only --diff src tests > reports/isort-report.txt 2>&1 || true
          
          # MyPy for type checking
          echo "ğŸ” Running type checking..."
          mypy src --ignore-missing-imports --html-report reports/mypy-html > reports/mypy-report.txt 2>&1 || true
          
          # Bandit for security
          echo "ğŸ”’ Running security analysis..."
          bandit -r src/ -f json -o reports/bandit-report.json -ll || true
          
          # Safety for dependency vulnerabilities
          echo "ğŸ›¡ï¸ Checking dependencies for vulnerabilities..."
          if [ -f requirements.txt ]; then
            safety check --file requirements.txt --json --output reports/safety-report.json || true
          fi

      - name: Upload code quality reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-quality-reports
          path: reports/

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
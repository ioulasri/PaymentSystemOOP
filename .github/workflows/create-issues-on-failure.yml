name: Create Issues on CI Failure

on:
  workflow_run:
    workflows: ["CI/CD Pipeline"]  # This should match your main CI workflow name
    types:
      - completed

permissions:
  issues: write
  contents: read

jobs:
  create-issue-on-failure:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Download workflow artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const script = require('./.github/scripts/download-artifacts.js');
            await script({ github, context, runId: ${{ github.event.workflow_run.id }} });

      - name: Get workflow run details
        id: workflow-details
        uses: actions/github-script@v7
        with:
          script: |
            const script = require('./.github/scripts/get-workflow-details.js');
            await script({ github, context, core, runId: ${{ github.event.workflow_run.id }} });

      - name: Get jobs details
        id: jobs-details
        uses: actions/github-script@v7
        with:
          script: |
            const script = require('./.github/scripts/get-jobs-details.js');
            await script({ github, context, core, runId: ${{ github.event.workflow_run.id }} });

      - name: Check for existing issue
        id: check-issue
        uses: actions/github-script@v7
        with:
          script: |
            const script = require('./.github/scripts/check-existing-issue.js');
            await script({
              github,
              context,
              core,
              branch: '${{ steps.workflow-details.outputs.head_branch }}'
            });

      - name: Create or update issue
        uses: actions/github-script@v7
        with:
          script: |
            const script = require('./.github/scripts/create-or-update-issue.js');
            const failedSteps = JSON.parse('${{ steps.jobs-details.outputs.failed_steps }}');

            await script({
              github,
              context,
              params: {
                branch: '${{ steps.workflow-details.outputs.head_branch }}',
                sha: '${{ steps.workflow-details.outputs.head_sha }}',
                runUrl: '${{ steps.workflow-details.outputs.run_url }}',
                runNumber: '${{ steps.workflow-details.outputs.run_number }}',
                actor: '${{ steps.workflow-details.outputs.triggering_actor }}',
                failedSteps: failedSteps,
                issueExists: '${{ steps.check-issue.outputs.issue_exists }}' === 'true',
                issueNumber: '${{ steps.check-issue.outputs.issue_number }}'
              }
            });

  close-issue-on-success:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Get workflow details
        id: workflow-details
        uses: actions/github-script@v7
        with:
          script: |
            const script = require('./.github/scripts/get-workflow-details.js');
            await script({ github, context, core, runId: ${{ github.event.workflow_run.id }} });

      - name: Close related issues
        uses: actions/github-script@v7
        with:
          script: |
            const script = require('./.github/scripts/close-ci-issues.js');
            await script({
              github,
              context,
              branch: '${{ steps.workflow-details.outputs.head_branch }}'
            });
